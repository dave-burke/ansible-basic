---
- name: Ensure static config file exists
  template:
    src: static.conf
    dest: "{{http_static_config_file}}"

- name: Ensure nginx container is started
  docker_container:
    name: "{{nginx_container}}"
    image: nginx
    pull: true
    state: started
    restart_policy: always
    ports:
      - 80:80/tcp
    volumes:
      - /etc/nginx/conf.d
      - /etc/nginx/vhost.d
      - "{{http_static_dir}}:/usr/share/nginx/html:ro"
      - "{{http_static_config_file}}:/etc/nginx/conf.d/static.conf:ro"
  register: docker_nginx_container_status

- name: Ensure docker-gen container is absent
  docker_container:
    name: nginx-gen
    image: "{{docker_gen_image}}"
    state: absent

- name: Ensure docker-gen image is absent
  docker_image: name={{docker_gen_image}} state=absent

- name: Ensure traefik container is started
  tags: ['traefik']
  docker_container:
    name: traefik
    image: traefik
    state: started
    restart_policy: unless-stopped
    ports:
      - 9081:8080/tcp
      - 9080:80/tcp
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    command: "--api.insecure=true --providers.docker"

