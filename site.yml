---
- hosts: all
  roles:
    - base

- hosts: compy
  roles:
    - users_dave
    - users_wesley
    - users_andrew
    - role: ssh_user
      user: dave
      authorized_hosts:
        - servy
        - happy
        - asuz
        - phone
        - tabby
    - development
    - photo_mgmt
    - syncthing
    - budget
    - backup_client
  tasks:
    - name: Ensure storage disk is mounted
      mount:
        path: "/mnt/storage"
        src: UUID=338a8dd5-3d41-433d-87c7-56a9339fa194
        fstype: ext3
        opts: defaults
        dump: "0"
        passno: "3"
        state: mounted

- hosts: asuz
  roles:
    - users_dave
    - users_suz
    - users_wesley
    - users_andrew
    - role: ssh_user
      user: dave
      authorized_hosts:
        - servy
        - compy
        - happy
    - syncthing
    - touchpad_toggle
    - backup_client

- hosts: servy
  roles:
    - users_dave
    - users_suz
    - role: ssh_user
      user: dave
      authorized_hosts:
        - compy
        - happy
        - asuz
        - phone
        - tabby
    - raid_storage
    - dns
    - vpn
    - reverse_proxy
    - syncthing
    - plex
    - budget_web
    - torrent
    - netmon
    - dyndns_client
    - minecraft_server
    - backup_client
    - backup_server
    - s3_sync
    - wasabi_cli
    - nfs_server
  tasks:
    - name: "Ensure {{item}} has access to syncthing GUI"
      tags: ['ufw', 'test']
      ufw:
        comment: 'Syncthing from {{item}}'
        rule: allow
        from_ip: "{{hostvars[item].ansible_host}}"
        port: '8384'
        proto: 'tcp'
      loop: ['compy','happy']
    - name: "Link to {{item}}"
      file: src=/mnt/storage/{{item}} dest=/home/{{user}}/{{item}} state=link
      with_items:
        - audio
        - backup
        - dev
        - photos
        - uploads
        - videos

- hosts: dropy
  roles:
    - role: ssh_user
      user: dave
      authorized_hosts:
        - compy
        - happy
        - phone
        - tabby
    - users_dave
    - jitsi_meet
    - minecraft_server
    - backup_client
    - murmur

- hosts: happy
  tasks:
    - name: Blacklist PC Speaker module
      tags: ['pcspeaker', 'pcspkr']
      copy:
        dest: /etc/modprobe.d/nobeep.conf
        content: "blacklist pcspkr"
  roles:
    - syncthing
    - users_dave
    - development
    - role: ssh_user
      user: dave
      authorized_hosts:
        - servy
        - phone
        - tabby
        - compy
